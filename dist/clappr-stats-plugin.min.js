!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("@guzzj/clappr-core")):"function"==typeof define&&define.amd?define(["@guzzj/clappr-core"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).ClapprStats=e(t.Clappr)}(this,(function(t){"use strict";function e(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function n(t){return(n=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function r(t,e){return(r=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function i(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function s(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,s=n(t);if(e){var o=n(this).constructor;r=Reflect.construct(s,arguments,o)}else r=s.apply(this,arguments);return i(this,r)}}function o(t,e,r){return(o="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,r){var i=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=n(t)););return t}(t,e);if(i){var s=Object.getOwnPropertyDescriptor(i,e);return s.get?s.get.call(r):s.value}})(t,e,r||t)}var a="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},c="__lodash_hash_undefined__",u="[object Function]",h="[object GeneratorFunction]",l=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,f=/^\w*$/,p=/^\./,_=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,y=/\\(\\)?/g,d=/^\[object .+?Constructor\]$/,v="object"==typeof a&&a&&a.Object===Object&&a,m="object"==typeof self&&self&&self.Object===Object&&self,T=v||m||Function("return this")();var b,g=Array.prototype,E=Function.prototype,w=Object.prototype,P=T["__core-js_shared__"],k=(b=/[^.]+$/.exec(P&&P.keys&&P.keys.IE_PROTO||""))?"Symbol(src)_1."+b:"",R=E.toString,O=w.hasOwnProperty,N=w.toString,A=RegExp("^"+R.call(O).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),C=T.Symbol,x=g.splice,B=G(T,"Map"),M=G(Object,"create"),S=C?C.prototype:void 0,F=S?S.toString:void 0;function I(t){var e=-1,n=t?t.length:0;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function j(t){var e=-1,n=t?t.length:0;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function L(t){var e=-1,n=t?t.length:0;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function H(t,e){for(var n,r,i=t.length;i--;)if((n=t[i][0])===(r=e)||n!=n&&r!=r)return i;return-1}function U(t,e){for(var n,r=0,i=(e=function(t,e){if(W(t))return!1;var n=typeof t;if("number"==n||"symbol"==n||"boolean"==n||null==t||q(t))return!0;return f.test(t)||!l.test(t)||null!=e&&t in Object(e)}(e,t)?[e]:W(n=e)?n:$(n)).length;null!=t&&r<i;)t=t[V(e[r++])];return r&&r==i?t:void 0}function D(t){return!(!K(t)||(e=t,k&&k in e))&&(function(t){var e=K(t)?N.call(t):"";return e==u||e==h}(t)||function(t){var e=!1;if(null!=t&&"function"!=typeof t.toString)try{e=!!(t+"")}catch(t){}return e}(t)?A:d).test(function(t){if(null!=t){try{return R.call(t)}catch(t){}try{return t+""}catch(t){}}return""}(t));var e}function z(t,e){var n,r,i=t.__data__;return("string"==(r=typeof(n=e))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==n:null===n)?i["string"==typeof e?"string":"hash"]:i.map}function G(t,e){var n=function(t,e){return null==t?void 0:t[e]}(t,e);return D(n)?n:void 0}I.prototype.clear=function(){this.__data__=M?M(null):{}},I.prototype.delete=function(t){return this.has(t)&&delete this.__data__[t]},I.prototype.get=function(t){var e=this.__data__;if(M){var n=e[t];return n===c?void 0:n}return O.call(e,t)?e[t]:void 0},I.prototype.has=function(t){var e=this.__data__;return M?void 0!==e[t]:O.call(e,t)},I.prototype.set=function(t,e){return this.__data__[t]=M&&void 0===e?c:e,this},j.prototype.clear=function(){this.__data__=[]},j.prototype.delete=function(t){var e=this.__data__,n=H(e,t);return!(n<0)&&(n==e.length-1?e.pop():x.call(e,n,1),!0)},j.prototype.get=function(t){var e=this.__data__,n=H(e,t);return n<0?void 0:e[n][1]},j.prototype.has=function(t){return H(this.__data__,t)>-1},j.prototype.set=function(t,e){var n=this.__data__,r=H(n,t);return r<0?n.push([t,e]):n[r][1]=e,this},L.prototype.clear=function(){this.__data__={hash:new I,map:new(B||j),string:new I}},L.prototype.delete=function(t){return z(this,t).delete(t)},L.prototype.get=function(t){return z(this,t).get(t)},L.prototype.has=function(t){return z(this,t).has(t)},L.prototype.set=function(t,e){return z(this,t).set(t,e),this};var $=Y((function(t){var e;t=null==(e=t)?"":function(t){if("string"==typeof t)return t;if(q(t))return F?F.call(t):"";var e=t+"";return"0"==e&&1/t==-1/0?"-0":e}(e);var n=[];return p.test(t)&&n.push(""),t.replace(_,(function(t,e,r,i){n.push(r?i.replace(y,"$1"):e||t)})),n}));function V(t){if("string"==typeof t||q(t))return t;var e=t+"";return"0"==e&&1/t==-1/0?"-0":e}function Y(t,e){if("function"!=typeof t||e&&"function"!=typeof e)throw new TypeError("Expected a function");var n=function(){var r=arguments,i=e?e.apply(this,r):r[0],s=n.cache;if(s.has(i))return s.get(i);var o=t.apply(this,r);return n.cache=s.set(i,o),o};return n.cache=new(Y.Cache||L),n}Y.Cache=L;var W=Array.isArray;function K(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}function q(t){return"symbol"==typeof t||function(t){return!!t&&"object"==typeof t}(t)&&"[object Symbol]"==N.call(t)}var J=function(t,e,n){var r=null==t?void 0:U(t,e);return void 0===r?n:r},X=function(i){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&r(t,e)}(l,i);var a,c,u,h=s(l);function l(t){var e;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,l),(e=h.call(this,t))._runEach=J(t,"options.clapprStats.runEach",5e3),e._onReport=J(t,"options.clapprStats.onReport",e._defaultReport),e._uriToMeasureLatency=J(t,"options.clapprStats.uriToMeasureLatency"),e._urisToMeasureBandwidth=J(t,"options.clapprStats.urisToMeasureBandwidth"),e._runBandwidthTestEvery=J(t,"options.clapprStats.runBandwidthTestEvery",10),e._bwMeasureCount=0,e._completion={watch:J(t,"options.clapprStats.onCompletion",[]),calls:[]},e._newMetrics(),e.on(l.REPORT_EVENT,e._onReport),e}return a=l,(c=[{key:"name",get:function(){return"clappr_stats"}},{key:"supportedVersion",get:function(){return{min:"0.4.2"}}},{key:"_playbackName",get:function(){return this.container.playback.name}},{key:"_playbackType",get:function(){return this.container.getPlaybackType()}},{key:"_now",value:function(){return window.performance&&"function"==typeof window.performance.now?window.performance.now():new Date}},{key:"_inc",value:function(t){this._metrics.counters[t]+=1}},{key:"_timerHasStarted",value:function(t){return void 0!==this["_start".concat(t)]}},{key:"_start",value:function(t){this["_start".concat(t)]=this._now()}},{key:"_stop",value:function(t){this._metrics.timers[t]+=this._now()-this["_start".concat(t)]}},{key:"_defaultReport",value:function(t){console.log(t)}},{key:"bindEvents",value:function(){var e=this;this.listenTo(this.container,t.Events.CONTAINER_BITRATE,this.onBitrate),this.listenTo(this.container,t.Events.CONTAINER_STOP,this.stopReporting),this.listenTo(this.container,t.Events.CONTAINER_ENDED,this.stopReporting),this.listenToOnce(this.container.playback,t.Events.PLAYBACK_PLAY_INTENT,this.startTimers),this.listenToOnce(this.container,t.Events.CONTAINER_PLAY,this.onFirstPlaying),this.listenTo(this.container,t.Events.CONTAINER_PLAY,this.onPlay),this.listenTo(this.container,t.Events.CONTAINER_PAUSE,this.onPause),this.listenToOnce(this.container,t.Events.CONTAINER_STATE_BUFFERING,this.onBuffering),this.listenTo(this.container,t.Events.CONTAINER_SEEK,this.onSeek),this.listenTo(this.container,t.Events.CONTAINER_ERROR,(function(){return e._inc("error")})),this.listenTo(this.container,t.Events.CONTAINER_FULLSCREEN,(function(){return e._inc("fullscreen")})),this.listenTo(this.container,t.Events.CONTAINER_PLAYBACKDVRSTATECHANGED,(function(t){t&&e._inc("dvrUsage")})),this.listenTo(this.container.playback,t.Events.PLAYBACK_PROGRESS,this.onProgress),this.listenTo(this.container.playback,t.Events.PLAYBACK_TIMEUPDATE,this.onTimeUpdate)}},{key:"destroy",value:function(){this.stopReporting(),o(n(l.prototype),"destroy",this).call(this)}},{key:"onBitrate",value:function(t){var e=parseInt(J(t,"bitrate",0),10),n=this._now();if(this._metrics.extra.bitratesHistory.length>0){var r=this._metrics.extra.bitratesHistory[this._metrics.extra.bitratesHistory.length-1];r.end=n,r.time=n-r.start}this._metrics.extra.bitratesHistory.push({start:this._now(),bitrate:e}),this._inc("changeLevel")}},{key:"stopReporting",value:function(){this._buildReport(),clearInterval(this._intervalId),this._newMetrics(),this.stopListening(),this.bindEvents()}},{key:"startTimers",value:function(){this._intervalId=setInterval(this._buildReport.bind(this),this._runEach),this._start("session"),this._start("startup")}},{key:"onFirstPlaying",value:function(){this.listenTo(this.container,t.Events.CONTAINER_TIMEUPDATE,this.onContainerUpdateWhilePlaying),this._start("watch"),this._stop("startup")}},{key:"playAfterPause",value:function(){this.listenTo(this.container,t.Events.CONTAINER_TIMEUPDATE,this.onContainerUpdateWhilePlaying),this._stop("pause"),this._start("watch")}},{key:"onPlay",value:function(){this._inc("play")}},{key:"onPause",value:function(){this._stop("watch"),this._start("pause"),this._inc("pause"),this.listenToOnce(this.container,t.Events.CONTAINER_PLAY,this.playAfterPause),this.stopListening(this.container,t.Events.CONTAINER_TIMEUPDATE,this.onContainerUpdateWhilePlaying)}},{key:"onSeek",value:function(t){this._inc("seek"),this._metrics.extra.watchHistory.push([1e3*t,1e3*t])}},{key:"onTimeUpdate",value:function(t){var e=1e3*t.current,n=1e3*t.total,r=this._metrics.extra.watchHistory.length;if(this._metrics.extra.duration=n,this._metrics.extra.currentTime=e,this._metrics.extra.watchedPercentage=e/n*100,0===r?this._metrics.extra.watchHistory.push([e,e]):this._metrics.extra.watchHistory[r-1][1]=e,this._metrics.extra.bitratesHistory.length>0){var i=this._metrics.extra.bitratesHistory[this._metrics.extra.bitratesHistory.length-1];i.end||(i.time=this._now()-i.start)}this._onCompletion()}},{key:"onContainerUpdateWhilePlaying",value:function(){this.container.playback.isPlaying()&&(this._stop("watch"),this._start("watch"))}},{key:"onBuffering",value:function(){this._inc("buffering"),this._start("buffering"),this.listenToOnce(this.container,t.Events.CONTAINER_STATE_BUFFERFULL,this.onBufferfull)}},{key:"onBufferfull",value:function(){this._stop("buffering"),this.listenToOnce(this.container,t.Events.CONTAINER_STATE_BUFFERING,this.onBuffering)}},{key:"onProgress",value:function(t){this._metrics.extra.buffersize=1e3*t.current}},{key:"_newMetrics",value:function(){this._metrics={counters:{play:0,pause:0,error:0,buffering:0,decodedFrames:0,droppedFrames:0,fps:0,changeLevel:0,seek:0,fullscreen:0,dvrUsage:0},timers:{startup:0,watch:0,pause:0,buffering:0,session:0,latency:0},extra:{playbackName:"",playbackType:"",bitratesHistory:[],bitrateWeightedMean:0,bitrateMostUsed:0,buffersize:0,watchHistory:[],watchedPercentage:0,bufferingPercentage:0,bandwidth:0,duration:0,currentTime:0}}}},{key:"_onCompletion",value:function(){var e=this._metrics.extra.watchedPercentage,n=this._completion.watch,r=-1!=this._completion.calls.indexOf(e);-1==n.indexOf(e)||r||(t.Log.info(this.name+" PERCENTAGE_EVENT: "+e),this._completion.calls.push(e),this.trigger(l.PERCENTAGE_EVENT,e))}},{key:"_buildReport",value:function(){this._stop("session"),this._start("session"),this._metrics.extra.playbackName=this._playbackName,this._metrics.extra.playbackType=this._playbackType,this._calculateBitrates(),this._calculatePercentages(),this._fetchFPS(),this._measureLatency(),this._measureBandwidth(),this.trigger(l.REPORT_EVENT,JSON.parse(JSON.stringify(this._metrics)))}},{key:"_fetchFPS",value:function(){var t={html5_video:this._html5FetchFPS,hls:this._html5FetchFPS,dash_shaka_playback:this._html5FetchFPS};t[this._playbackName]&&t[this._playbackName].call(this)}},{key:"_calculateBitrates",value:function(){var t=this._metrics.extra.bitratesHistory.map((function(t){return t.time})).reduce((function(t,e){return t+e}),0);this._metrics.extra.bitrateWeightedMean=this._metrics.extra.bitratesHistory.map((function(t){return t.bitrate*t.time})).reduce((function(t,e){return t+e}),0)/t,this._metrics.extra.bitratesHistory.length>0&&(this._metrics.extra.bitrateMostUsed=this._metrics.extra.bitratesHistory.slice().sort((function(t,e){return t.time<e.time}))[0].bitrate)}},{key:"_calculatePercentages",value:function(){this._metrics.extra.duration>0&&(this._metrics.extra.bufferingPercentage=this._metrics.timers.buffering/this._metrics.extra.duration*100)}},{key:"_html5FetchFPS",value:function(){var t=this.container.playback.el,e=t.webkitDecodedFrameCount||t.mozDecodedFrames||0,n=t.webkitDroppedFrameCount||t.mozParsedFrames-t.mozDecodedFrames||0,r=e-(this._lastDecodedFramesCount||0);this._metrics.counters.decodedFrames=e,this._metrics.counters.droppedFrames=n,this._metrics.counters.fps=r/(this._runEach/1e3),this._lastDecodedFramesCount=e}},{key:"_measureLatency",value:function(){var t=this;if(this._uriToMeasureLatency){var e,n=[],r=function(){e=n[2]-n[1],t._metrics.timers.latency=e};!function e(){if(n.push(t._now()),n.length>2)r();else{var i=new Image;i.onload=e,i.src=t._uriToMeasureLatency+"?"+Math.random()+"="+t._now()}}()}}},{key:"_measureBandwidth",value:function(){var t=this;if(this._urisToMeasureBandwidth&&this._bwMeasureCount%this._runBandwidthTestEvery==0){var e=0,n=function(n){var r=(t._urisToMeasureBandwidth[e-1].end-t._urisToMeasureBandwidth[e-1].start)/1e3,i=8*n.loaded/r;t._metrics.extra.bandwidth=i,t._urisToMeasureBandwidth.forEach((function(t){t.start=0,t.end=0,t.expired=!1,clearTimeout(t.timer)}))};!function r(i){if(e>0&&(t._urisToMeasureBandwidth[e-1].end=t._now(),clearTimeout(t._urisToMeasureBandwidth[e-1].timer)),e>=t._urisToMeasureBandwidth.length||e>0&&t._urisToMeasureBandwidth[e-1].expired)n(i);else{var s=new XMLHttpRequest;s.open("GET",t._urisToMeasureBandwidth[e].url,!0),s.responseType="arraybuffer",s.onload=s.onabort=r,t._urisToMeasureBandwidth[e].start=t._now(),t._urisToMeasureBandwidth[e].timer=setTimeout((function(e){t._urisToMeasureBandwidth[e].expired=!0,s.abort()}),t._urisToMeasureBandwidth[e].timeout,e),s.send()}e++}()}this._bwMeasureCount++}}])&&e(a.prototype,c),u&&e(a,u),l}(t.ContainerPlugin);return X.REPORT_EVENT="clappr:stats:report",X.PERCENTAGE_EVENT="clappr:stats:percentage",X}));
